<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>티켓팅 시스템 - 대시보드</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #007bff; padding-bottom: 15px; margin-bottom: 30px; }
        .welcome { color: #333; }
        .logout-btn { background: #dc3545; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; }
        .logout-btn:hover { background: #c82333; }
        .card { border: 1px solid #ddd; padding: 20px; border-radius: 8px; margin: 20px 0; background: #f8f9fa; }
        .card h3 { margin-top: 0; color: #007bff; }
        .btn { display: inline-block; background: #007bff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 4px; margin: 5px; }
        .btn:hover { background: #0056b3; }
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { background: #545b62; }
        .status { padding: 10px; border-radius: 4px; margin: 10px 0; }
        .status.logged-out { background: #f8d7da; color: #721c24; }
        .status.logged-in { background: #d4edda; color: #155724; }
        .token-info { background: #fff3cd; padding: 10px; border-radius: 4px; margin: 10px 0; font-family: monospace; font-size: 12px; word-break: break-all; }
    </style>
</head>
<body>
<div class="header">
    <h1>티켓팅 시스템 대시보드</h1>
    <div id="userInfo">
        <button class="logout-btn" onclick="logout()" id="logoutBtn" style="display: none;">로그아웃</button>
    </div>
</div>

<div id="loginStatus" class="status logged-out">
    로그인이 필요합니다.
</div>

<div class="card">
    <h3>인증 시스템</h3>
    <p>JWT 기반 로그인/인증 기능</p>
    <a href="/login" class="btn">로그인하기</a>
    <a href="/admin/login" class="btn">관리자 로그인</a>
    <button class="btn btn-secondary" onclick="checkToken()">토큰 상태 확인</button>
</div>

<div class="card" id="apiTestCard" style="display: none;">
    <h3>API 테스트</h3>
    <p>인증이 필요한 API들을 테스트해보세요</p>
    <button class="btn" onclick="testProtectedAPI()">보호된 API 테스트</button>
    <button class="btn btn-secondary" onclick="testHealthCheck()">Health Check</button>
</div>

<div class="card">
    <h3>시스템 정보</h3>
    <ul>
        <li><strong>API 베이스 URL:</strong> http://localhost:8080</li>
        <li><strong>로그인 엔드포인트:</strong> POST /auth/login</li>
        <li><strong>로그아웃 엔드포인트:</strong> POST /auth/logout</li>
    </ul>
</div>

<div id="results" style="margin-top: 20px;"></div>

<script>
    // 페이지 로드 시 토큰 상태 확인
    window.addEventListener('load', () => {
        updateLoginStatus();
    });

    function updateLoginStatus() {
        const token = localStorage.getItem('accessToken');
        const userType = localStorage.getItem('userType');
        const loginStatus = document.getElementById('loginStatus');
        const logoutBtn = document.getElementById('logoutBtn');
        const loginLink = document.getElementById('loginLink');
        const apiTestCard = document.getElementById('apiTestCard');
        const userInfo = document.getElementById('userInfo');

        if (token) {
            loginStatus.className = 'status logged-in';
            loginStatus.innerHTML = `
                    <strong>로그인됨</strong><br>
                    사용자 유형: ${userType}<br>
                    토큰 만료까지: ${getTokenTimeLeft(token)}
                `;
            logoutBtn.style.display = 'inline-block';
            loginLink.style.display = 'none';
            apiTestCard.style.display = 'block';

            // 사용자 정보 표시
            userInfo.innerHTML = `
                    <span style="margin-right: 15px; color: #28a745;">
                        ${userType} 로그인됨
                    </span>
                    <button class="logout-btn" onclick="logout()">로그아웃</button>
                `;
        } else {
            loginStatus.className = 'status logged-out';
            loginStatus.innerHTML = '로그인이 필요합니다.';
            logoutBtn.style.display = 'none';
            loginLink.style.display = 'inline-block';
            apiTestCard.style.display = 'none';
            userInfo.innerHTML = '<a href="/login.html" class="btn">로그인</a>';
        }
    }

    function getTokenTimeLeft(token) {
        try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            const exp = payload.exp * 1000;
            const now = Date.now();
            const timeLeft = exp - now;

            if (timeLeft <= 0) {
                return '만료됨';
            }

            const minutes = Math.floor(timeLeft / (1000 * 60));
            return `약 ${minutes}분`;
        } catch (e) {
            return '알 수 없음';
        }
    }

    async function logout() {
        const token = localStorage.getItem('accessToken');

        try {
            const response = await fetch('/auth/logout', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            const result = await response.json();

            // 로컬 스토리지에서 토큰 삭제
            localStorage.removeItem('accessToken');
            localStorage.removeItem('userType');

            // UI 업데이트
            updateLoginStatus();

            document.getElementById('results').innerHTML = `
                    <div class="status logged-out">
                        <strong>로그아웃 완료:</strong> ${result.message}
                    </div>
                `;

        } catch (error) {
            console.error('로그아웃 실패:', error);
            // 에러가 발생해도 클라이언트 토큰은 삭제
            localStorage.removeItem('accessToken');
            localStorage.removeItem('userType');
            updateLoginStatus();
        }
    }

    function checkToken() {
        const token = localStorage.getItem('accessToken');
        const results = document.getElementById('results');

        if (token) {
            results.innerHTML = `
                    <div class="token-info">
                        <strong>저장된 JWT 토큰:</strong><br>
                        ${token}<br><br>
                        <strong>토큰 길이:</strong> ${token.length}자<br>
                        <strong>만료 시간:</strong> ${getTokenTimeLeft(token)}
                    </div>
                `;
        } else {
            results.innerHTML = `
                    <div class="status logged-out">
                        저장된 토큰이 없습니다.
                    </div>
                `;
        }
    }

    async function testProtectedAPI() {
        const token = localStorage.getItem('accessToken');
        const results = document.getElementById('results');

        if (!token) {
            results.innerHTML = '<div class="status logged-out">로그인이 필요합니다.</div>';
            return;
        }

        try {
            const response = await fetch('/actuator/health', {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            const data = await response.text();
            results.innerHTML = `
                    <div class="status logged-in">
                        <strong>API 테스트 성공</strong><br>
                        상태 코드: ${response.status}<br>
                        응답: ${data}
                    </div>
                `;
        } catch (error) {
            results.innerHTML = `
                    <div class="status logged-out">
                        API 테스트 실패: ${error.message}
                    </div>
                `;
        }
    }

    async function testHealthCheck() {
        try {
            const response = await fetch('/actuator/health');
            const data = await response.text();

            document.getElementById('results').innerHTML = `
                    <div class="status logged-in">
                        <strong>Health Check</strong><br>
                        상태: ${response.status}<br>
                        응답: ${data}
                    </div>
                `;
        } catch (error) {
            document.getElementById('results').innerHTML = `
                    <div class="status logged-out">
                        Health Check 실패: ${error.message}
                    </div>
                `;
        }
    }
</script>
</body>
</html>